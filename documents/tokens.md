tokens
======

**tokens**は文書を語に分割した状態で効率的に処理する**quanteda**の独自オブジェクト。**tokens**の作成・操作を行う関数は`tokens_*`と命名されている。トークン化（tokenization）とは、自然言語を機械が扱える形に変換する処理を指す。

作成
----

`tokens()`は[**ICU**](http://site.icu-project.org)に内蔵された辞書に基づき、日本語(および中国語)のトークン化を行うたため、MecabやChasenなどの形態素解析ツールを必要としない。テキストがあらかじめ半角スペースで分かち書きされている場合は、`what = "fastestword"`とする。

``` r
require(quanteda) # パッケージの読み込み
```

``` r
# 分かち書きされている場合
load('data/data_corpus_asahi_2016_seg.RData') # Mecabで分かち書き済み
toks <- tokens(data_corpus_asahi_2016_seg, what = "fastestword", remove_punct = FALSE)

# 分かち書きされていない場合
load('data/data_corpus_asahi_2016.RData') 
toks <- tokens(data_corpus_asahi_2016, remove_punct = FALSE)
```

**quanteda**は**Mecab**を呼び出す関数を含んでいないが、**RMeCab**を用いると容易に[Mecabによる分かち書き](../extra/mecab.R)を行える

操作
----

**tokens**は語の位置を保持するため`padding = TRUE`とすると、削除した語が空文字となり、元々の語の距離を維持することができる。

``` r
# 文字以外を削除
toks <- tokens_select(toks, '^[０-９ぁ-んァ-ヶー一-龠]+$', valuetype = 'regex', padding = TRUE)
# ひらがなを削除
toks <- tokens_remove(toks, '^[ぁ-ん]+$', valuetype = 'regex', padding = TRUE)

# KWICで用例を確認
head(kwic(toks, "トランプ"), 20)
```

    ##                                                   
    ##    [text12, 357]          放言 続ける | トランプ |
    ##    [text13, 420]       党 トップ 走る | トランプ |
    ##    [text13, 490]                 右翼 | トランプ |
    ##    [text68, 342]     実業 家 ドナルド | トランプ |
    ##    [text68, 438]          逆に 上がる | トランプ |
    ##    [text68, 481]              影響 大 | トランプ |
    ##    [text303, 53]            不動産 王 | トランプ |
    ##   [text303, 106]         不信 感 強い | トランプ |
    ##   [text303, 136]                      | トランプ |
    ##   [text303, 224]                 過ぎ | トランプ |
    ##   [text303, 255]                   叫 | トランプ |
    ##   [text303, 296]            大 隔たる | トランプ |
    ##  [text337, 1059]         候補 座 争う | トランプ |
    ##   [text376, 578]   首位 走る ドナルド | トランプ |
    ##    [text431, 50] 人気 集める ドナルド | トランプ |
    ##   [text431, 105]         訴え 国際 面 | トランプ |
    ##   [text431, 438]            爆撃 主張 | トランプ |
    ##   [text443, 342]       党 大統領 候補 | トランプ |
    ##   [text443, 417]              強 批判 | トランプ |
    ##    [text444, 61]   首位 走る ドナルド | トランプ |
    ##                           
    ##  氏 人気 衰え             
    ##  氏 メキシコ 移民         
    ##  氏 敵                    
    ##  氏 支持 率               
    ##  氏 当選 可能性           
    ##  氏 に関する 話題 大統領  
    ##  氏 優位 立               
    ##  氏 心理                  
    ##  人気                     
    ##  人気 衰え 見             
    ##  氏 有力                  
    ##  流 ポピュリズム 大衆 迎合
    ##  氏 イスラム教 徒         
    ##  氏 イスラム教 徒         
    ##  氏 排外 主義 的          
    ##  氏 批判 随所             
    ##  氏 イスラム教 徒         
    ##  氏 イスラム教 徒         
    ##  氏 排外 主義             
    ##  氏 暗 批判

``` r
# KWICをより見やすく別のウィンドウで表示
View(head(kwic(toks, "トランプ"), 100))
```

``` r
# Nグラムの生成
toks_ngram <- tokens_ngrams(toks, n = 2)
head(toks_ngram[[1]], 20)
```

    ##  [1] "衆_院"     "院_議員"   "残り_３"   "３_年"     "年_近く"  
    ##  [6] "安倍_晋"   "晋_三"     "三_首相"   "衆_参"     "参_同日"  
    ## [11] "同日_選"   "衆_院"     "院_解散"   "憲法_改正" "含む_今夏"
    ## [16] "今夏_以降" "政権_運営" "同日_選"   "続く_三つ" "判断_材料"

分析
----

### 辞書分析

``` r
# 地理的辞書の読み込み (Watanabe 2017)
dict <- dictionary(file = 'extra/watanabe_country.yml')
head(dict['ASIA'])
```

    ## Dictionary object with 1 primary key entry and 3 nested levels.
    ## - ASIA:
    ##   - CENTER:
    ##     - KZ:
    ##       - カザフスタン*, カザフ*, アスタナ
    ##     - KG:
    ##       - キルギスタン*, キルギス*, ビシュケク
    ##     - TJ:
    ##       - タジキスタン*, タジック*, ドゥシャンベ
    ##     - TM:
    ##       - トルクメニスタン*, トルクメン*, アシャバード
    ##     - UZ:
    ##       - ウズベキスタン*, ウズベク*, タシケント
    ##   - EAST:
    ##     - CN:
    ##       - 中華人民共和国*, 中国*, 北京, 上海
    ##     - TW:
    ##       - 中華民国*, 台湾*, 台北
    ##     - HK:
    ##       - 香港*
    ##     - MO:
    ##       - マカオ*
    ##     - KP:
    ##       - 朝鮮民主主義人民共和国*, 北朝鮮*, 平壌
    ##     - JP:
    ##       - 日本*, 東京
    ##     - MN:
    ##       - モンゴル*, ウランバートル
    ##     - KR:
    ##       - 大韓民国*, 韓国, ソウル
    ##   - SOUTH:
    ##     - AF:
    ##       - アフガニスタン*, アフガン, カブール
    ##     - BD:
    ##       - バングラデシュ*, ダッカ, ダッカ
    ##     - BT:
    ##       - ブータン*, ティンプー
    ##     - IN:
    ##       - インド*, ムンバイ, ニューデリー
    ##     - IR:
    ##       - イラン*, テヘラン
    ##     - MV:
    ##       - モルディブ*
    ##     - NP:
    ##       - ネパール*, カトマンズ
    ##     - PK:
    ##       - パキスタン*, イスラマバード
    ##     - LK:
    ##       - スリランカ*, コロンボ
    ##   - SOUTH-EAST:
    ##     - BN:
    ##       - ブルネイ*
    ##     - KH:
    ##       - カンボジア*, プノンペン
    ##     - ID:
    ##       - インドネシア*, ジャカルタ
    ##     - LA:
    ##       - ラオス*, ビエンチャン
    ##     - MY:
    ##       - マレーシア*, クアラルンプール, プトラジャヤ
    ##     - MM:
    ##       - ミャンマー*, ビルマ*, ヤンゴン, ナイピドー
    ##     - PH:
    ##       - フィリピン*, マニラ
    ##     - SG:
    ##       - シンガポール*
    ##     - TH:
    ##       - タイ*, バンコク
    ##     - TL:
    ##       - 東ティモール*, ディリ
    ##     - VN:
    ##       - ベトナム*, ハノイ, ホーチミン市
    ##   - WEST:
    ##     - AM:
    ##       - アルメニア*, イェレヴァン
    ##     - AZ:
    ##       - アゼルバイジャン*, アゼリ*, バクー
    ##     - BH:
    ##       - バーレーン*, マナマ
    ##     - CY:
    ##       - キプロス*, ニコシア
    ##     - GE:
    ##       - グルジア*, トビリシ
    ##     - IQ:
    ##       - イラク*, バグダッド
    ##     - IL:
    ##       - イスラエル*, エルサレム
    ##     - JO:
    ##       - ヨルダン*, アンマン
    ##     - KW:
    ##       - クウェート*, クウェートシティ
    ##     - LB:
    ##       - レバノン*, ベイルート
    ##     - PS:
    ##       - パレスチナ*, ガザ市, ガザ, ウェストバンク
    ##     - OM:
    ##       - オマーン*, マスカット
    ##     - QA:
    ##       - カタール*, ドーハ
    ##     - SA:
    ##       - サウジアラビア*, リヤド
    ##     - SY:
    ##       - シリア*, ダマスカス
    ##     - TR:
    ##       - トルコ*, アンカラ, イスタンブール
    ##     - AE:
    ##       - アラブ首長国連邦*, ドバイ, アブダビ
    ##     - YE:
    ##       - イエメン*, サナア

``` r
# 国コードでtokensを作成
toks_country <- tokens_lookup(toks, dict, levels = 3) 
head(toks_country)
```

    ## tokens from 6 documents.
    ## text1 :
    ## [1] "TH" "TH" "JP"
    ## 
    ## text2 :
    ##  [1] "KR" "KR" "KR" "JP" "KR" "KR" "KR" "JP" "KR" "KR"
    ## 
    ## text3 :
    ##  [1] "HK" "JP" "JP" "HK" "JP" "JP" "JP" "JP" "JP" "JP" "JP" "JP" "JP" "JP"
    ## [15] "JP" "JP" "JP"
    ## 
    ## text4 :
    ##  [1] "US" "US" "JP" "CN" "CN" "US" "US" "CN" "CN" "CN" "US" "JP" "CN" "CN"
    ## [15] "US" "CN" "CN" "JP" "VN" "US" "US" "US" "QA" "US" "US" "US" "CN" "US"
    ## 
    ## text5 :
    ## [1] "CN" "CN" "CN"
    ## 
    ## text6 :
    ##  [1] "KR" "KR" "KR" "JP" "KR" "KR" "KR" "KR" "KR" "JP" "JP" "KR"

``` r
# 集計
mx_country <- dfm(toks_country)
county_top <- topfeatures(mx_country)
```

``` r
barplot(county_top)
```

![](tokens_files/figure-markdown_github/plot-1.png)

共起語分析
----------

連続的共起語を分析する際は、どのような種類の語の連続を抽出するのかを考慮し、句読点を削除する際も語の間の距離が維持されている必要がある。このために、上記の例では、`tokens()`において`remove_punct = FALSE`とし、`tokens_remove()`おいては`padding = TRUE`としてある。

``` r
# 連続的共起語の抽出
seqs <- textstat_collocations(toks, 'bj', features = '^[０-９ァ-ヶー一-龠]+$', 
                              valuetype = 'regex', min_count = 10, nested = FALSE)
head(seqs, 20)
```

    ##      collocation count length   lambda        sigma         z p
    ## 1    トランプ 氏  2766      2 53.84311 0.0004719711 114081.37 0
    ## 2  クリントン 氏   858      2 50.29571 0.0008617350  58365.63 0
    ## 3      オバマ 氏   854      2 50.27590 0.0008659375  58059.51 0
    ## 4        政治 的   825      2 49.89219 0.0009857003  50615.99 0
    ## 5        具体 的  1154      2 50.47862 0.0010214462  49418.77 0
    ## 6        参院 選  4110      2 52.91081 0.0010834186  48836.90 0
    ## 7          ２ 人  1291      2 50.59604 0.0010570759  47864.15 0
    ## 8          １ 人  1081      2 50.03965 0.0011584030  43197.10 0
    ## 9      日本 政府  1404      2 50.58779 0.0011801564  42865.32 0
    ## 10       舛添 氏   486      2 48.57975 0.0011508007  42213.87 0
    ## 11       積極 的   866      2 49.60554 0.0011858184  41832.33 0
    ## 12         朴 氏   475      2 48.50927 0.0011647123  41649.14 0
    ## 13       甘利 氏   455      2 48.38607 0.0011873405  40751.64 0
    ## 14         １ ８  1178      2 50.02727 0.0012582579  39759.15 0
    ## 15       関係 者   945      2 49.60646 0.0013050863  38010.09 0
    ## 16       小池 氏   392      2 47.94329 0.0012759697  37574.00 0
    ## 17         ３ 人   849      2 49.30906 0.0013291343  37098.63 0
    ## 18       担当 者   882      2 49.34250 0.0013897891  35503.59 0
    ## 19       高齢 者   831      2 49.17853 0.0014214481  34597.48 0
    ## 20         習 氏   335      2 47.45614 0.0013908410  34120.47 0

``` r
# 共起語の結合
toks_comp <- tokens_compound(toks, seqs[seqs$p < 0.01,], valuetype = 'fixed', 
                             concatenator = '', join = TRUE)

head(kwic(toks, "トランプ*", window = 10)) # 結合前
```

    ##                                                               
    ##  [text12, 357]              入国 禁止 放言 続ける | トランプ |
    ##  [text13, 420]      大統領 選 共和 党 トップ 走る | トランプ |
    ##  [text13, 490]                        過激派 右翼 | トランプ |
    ##  [text68, 342]  政治 経験 乏しい 実業 家 ドナルド | トランプ |
    ##  [text68, 438]            支持 下がる 逆に 上がる | トランプ |
    ##  [text68, 481]                            影響 大 | トランプ |
    ##                                   
    ##  氏 人気 衰え 分断 分断           
    ##  氏 メキシコ 移民 イスラム教 徒 敵
    ##  氏 敵 戦                         
    ##  氏 支持 率 首位 走る             
    ##  氏 当選 可能性 高い              
    ##  氏 に関する 話題 大統領 選 乗 取

``` r
head(kwic(toks_comp, "トランプ*", , window = 10)) # 結合後
```

    ##                                                                 
    ##  [text12, 339]  イスラム教徒 入国禁止 放言 続ける | トランプ氏 |
    ##  [text13, 396] 注目 米大統領選 共和党 トップ 走る | トランプ氏 |
    ##  [text13, 463]                        過激派 右翼 | トランプ氏 |
    ##  [text68, 304] 縫 政治経験 乏しい 実業家 ドナルド | トランプ氏 |
    ##  [text68, 395]            支持 下がる 逆に 上がる | トランプ氏 |
    ##  [text68, 436]                            影響 大 | トランプ氏 |
    ##                                
    ##   人気 衰え 分断 分断          
    ##   メキシコ 移民 イスラム教徒 敵
    ##   敵 戦                        
    ##   支持率 首位 走る 手法        
    ##   当選 可能性 高い             
    ##  に関する 話題 大統領選 乗 取
